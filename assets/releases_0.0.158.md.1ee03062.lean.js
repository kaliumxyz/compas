import{_ as n,c as a,o as s,a as e}from"./app.d0d65fcc.js";const g='{"title":"Release notes v0.0.158","description":"","frontmatter":{},"headers":[{"level":2,"title":"Cli","slug":"cli"},{"level":2,"title":"Lint config","slug":"lint-config"},{"level":2,"title":"Code gen","slug":"code-gen"},{"level":3,"title":"Types","slug":"types"},{"level":3,"title":"Validators","slug":"validators"},{"level":2,"title":"In closing","slug":"in-closing"}],"relativePath":"releases/0.0.158.md","lastUpdated":1635769453832}',t={},o=e(`__VP_STATIC_START__<h1 id="release-notes-v0-0-158" tabindex="-1">Release notes v0.0.158 <a class="header-anchor" href="#release-notes-v0-0-158" aria-hidden="true">#</a></h1><p>This release shifts the development experience for TS language server users (and sort of forces others to become one). As far as I know, <a href="https://github.com/compasjs/compas/pull/1055" target="_blank" rel="noopener noreferrer">this (#1055)</a> has been the longest open PR that got merged, and even has a predecessor, <a href="https://github.com/compasjs/compas/pull/461" target="_blank" rel="noopener noreferrer">#461</a>, back in November 2020. So let&#39;s get started.</p><h2 id="cli" tabindex="-1">Cli <a class="header-anchor" href="#cli" aria-hidden="true">#</a></h2><p>The Compas cli got a new command: <code>yarn compas init --jscconfig</code>. It (over)writes the <code>jsconfig.json</code> in the project directory. This file will become stricter over time, so keep it updated with Compas releases. This command and file is not necessary when only using the frontend code generators, because they imply an existing Typescript setup. To control the Typescript version used, you should add &#39;typescript&#39; as a &#39;devDependency&#39; in you project.</p><h2 id="lint-config" tabindex="-1">Lint config <a class="header-anchor" href="#lint-config" aria-hidden="true">#</a></h2><p>Since we are adding Typescript definition files to the project, disable automatic fixing of ESLint in your IDE for <code>.ts</code> and <code>.d.ts</code> files. This can be skipped if your ESLint config supports TypeScript files, the <code>@compas/lint-config</code> ones don&#39;t.</p><h2 id="code-gen" tabindex="-1">Code gen <a class="header-anchor" href="#code-gen" aria-hidden="true">#</a></h2><h3 id="types" tabindex="-1">Types <a class="header-anchor" href="#types" aria-hidden="true">#</a></h3><p>The first change in the code generators is that we now always create a <code>structure.js</code> file with the used generator options. This is used is &#39;multi-generate&#39; projects to combine all types in to a single <code>types.d.ts</code> file to avoid type conflicts down the road.</p><p>In a single generate project, e.g. only a single <code>app.generate</code> call, only a single addition is necessary. Add the following snippet after your <code>app.generate</code>:</p><div class="language-js"><pre><code><span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">generateTypes</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  outputDirectory<span class="token operator">:</span> <span class="token string">&quot;./types/generated&quot;</span><span class="token punctuation">,</span>
  inputPaths<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  dumpCompasTypes<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>dumpCompasTypes</code> option tells Compas to create a type definition file that makes all major exported types from Compas global in the project. By doing it this way you don&#39;t have to import types like <code>App</code> like</p><div class="language-js"><pre><code><span class="token comment">/**
 * @typedef {import(&quot;@compas/stdlib&quot;).App} App
 */</span>
</code></pre></div><p>in your project.</p><p>In a multi generate project things are a bit more complicated. We have to prevent type conflicts of global types. To ensure this we use the <code>dumpStructure</code> option of <code>app.generate</code> and use <code>app.generateTypes</code> to combine all &#39;structures&#39; in to a single type definition file.</p><ul><li>Explicitly mention the <code>enabledGenerators</code> in each <code>app.generate</code> call, but don&#39;t add the <code>type</code> generator. When <code>type</code> is the only generator, <code>enabledGenerators</code> may be an empty array.</li><li>Add <code>dupmStructure: true</code> to each <code>app.generate</code> call.</li><li>Add the above <code>app.generateTypes</code> call, but in <code>inputPaths</code> specify each <code>outputDirectory</code> of your <code>app.generate</code> calls.</li></ul><p>This should give you a single type definition file specifying all necessary types.</p><h3 id="validators" tabindex="-1">Validators <a class="header-anchor" href="#validators" aria-hidden="true">#</a></h3><p>Another generator that got a big change is the validator generator. It now collects as many errors as possible before returning an <code>{ error }</code> or <code>{ value }</code> object. This is combined with a few breaking changes:</p><ul><li>No TypeScript file support anymore, so the <code>app.generate</code> call will throw if used in combination with <code>useTypescript: true</code>.</li><li>The <code>throwingValidator</code> option is removed, as validators will never throw but instead return an <code>{ error: AppError }</code> object if any validation error occurred.</li><li>The top-level error key is always <code>validator.error</code>. All other validation keys are now nested in the &#39;info&#39; object, with keys representing the &#39;property path&#39; and values containing the specific validation error and any information. A full example looks something like: <ul><li>Type definition:</li></ul><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token constant">T</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeCreator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token punctuation">{</span>
  foo<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">.</span><span class="token function">bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  bar<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">.</span><span class="token function">anyOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;car&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;bicycle&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>Input:</li></ul><div class="language-json"><pre><code><span class="token punctuation">{</span>
  <span class="token property">&quot;bar&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scooter&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Resulting error:</li></ul><div class="language-json"><pre><code><span class="token punctuation">{</span>
  <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;validator.error&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;info&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;$.foo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;validation.boolean.undefined&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;info&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;$.bar&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;validator.anyOf&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;$.bar.type&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;validator.string.oneOf&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;info&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;oneOf&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;car&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;validator.string.oneOf&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;info&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;oneOf&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;bicycle&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul><p>Note that for <code>anyOf</code> validators the result may contain an array, since the property path may be the same.</p><h2 id="in-closing" tabindex="-1">In closing <a class="header-anchor" href="#in-closing" aria-hidden="true">#</a></h2><p>There is a bunch of improvements &amp; automation to be added, like auto generating documentation from the generated type definitions, writing tests for the type definitions and making the public api surface more strict by adding <code>@private</code> tags. But that&#39;s stuff for the future, for now I am back focussing on feature stability and some improvements &amp; additions to existing features.</p><p>As always please report missing type definitions and report bugs, thanks!</p>__VP_STATIC_END__`,24),p=[o];function c(i,r,l,u,d,k){return s(),a("div",null,p)}var y=n(t,[["render",c]]);export{g as __pageData,y as default};
