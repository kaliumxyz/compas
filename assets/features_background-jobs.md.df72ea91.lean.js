import{_ as n,c as a,o as s,a as e}from"./app.d0d65fcc.js";const b='{"title":"Background jobs","description":"","frontmatter":{},"headers":[{"level":2,"title":"API","slug":"api"},{"level":3,"title":"JobQueueWorker","slug":"jobqueueworker"}],"relativePath":"features/background-jobs.md","lastUpdated":1635769453832}',t={},o=e(`__VP_STATIC_START__<h1 id="background-jobs" tabindex="-1">Background jobs <a class="header-anchor" href="#background-jobs" aria-hidden="true">#</a></h1><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>Requires <code>@compas/store</code> to be installed</p></div><p>The queue system is based on &#39;static&#39; units of work to be done in the background. It supports the following:</p><ul><li>Job priority&#39;s. Lower value means higher priority.</li><li>Scheduling jobs at a set time</li><li>Customizable handler timeouts</li><li>Recurring job handling</li><li>Concurrent workers pulling from the same queue</li><li>Specific workers for a specific job</li></ul><p>When to use which function of adding a job:</p><ul><li><code>addEventToQueue</code>: use the queue as an &#39;external&#39; message bus to do things based on user flows, like sending an verification email on when registering. Jobs created will have a priority of &#39;2&#39;.</li><li><code>addJobToQueue</code>: use the queue as background processing of defined units. Like converting a file to different formats, sending async or scheduled notifications. Jobs created will have a priority of &#39;5&#39;.</li><li><code>addRecurringJobToQueue</code>: use the queue for recurring background processing, like cleaning up sessions, generating daily reports. The interval can be as low as a second. Jobs created will have a priority of &#39;4&#39;. This means the recurring jobs are by default more important than normal jobs. However there are no guarantees that jobs are running exactly on the time they are scheduled.</li><li><code>addJobWithCustomTimeoutToQueue</code>: when the unit of work is hard to define statically for the job. For example an external api that needs all information in a single call, but the amount of information is of value N. And N doesn&#39;t have any bounds and is only known when the job is created. However, this sort of still enforces that the unit of work is related to some other property to consistently calculate a custom timeout. These jobs have a priority of &#39;5&#39; by default.</li></ul><p>The handler can be passed in, in 2 ways;</p><ul><li>A single handler dispatching over the different jobs in application code</li><li>A plain JS object containing job names as strings, and handler with optional timeout as value.</li></ul><p>The timeout of a created job overwrites the specific job timeout which overwrites the &#39;handlerTimeout&#39; option.</p><p>Note that a lower priority value means a higher priority.</p><h2 id="api" tabindex="-1">API <a class="header-anchor" href="#api" aria-hidden="true">#</a></h2><p>Provided by <code>@compas/store</code>.</p><p>See also:</p><ul><li><a href="https://compasjs.com/api/store.html#addeventtoqueue" target="_blank" rel="noopener noreferrer"><code>addEventToQueue</code></a></li><li><a href="https://compasjs.com/api/store.html#addjobtoqueue" target="_blank" rel="noopener noreferrer"><code>addJobToQueue</code></a></li><li><a href="https://compasjs.com/api/store.html#addrecurringjobtoqueue" target="_blank" rel="noopener noreferrer"><code>addRecurringJobToQueue</code></a></li><li><a href="https://compasjs.com/api/store.html#addjobwithcustomtimeouttoqueue" target="_blank" rel="noopener noreferrer"><code>addJobWithCustomTimeoutToQueue</code></a></li></ul><h3 id="jobqueueworker" tabindex="-1">JobQueueWorker <a class="header-anchor" href="#jobqueueworker" aria-hidden="true">#</a></h3><p>A class representing a worker. By default a JobQueueWorker handles all jobs, however it is possible to have a specific worker for jobs with specific names.</p><p><strong>constructor()</strong>:</p><p>Create a new JobQueueWorker instance.</p><p>Parameters:</p><ul><li><p><code>sql</code>: A Postgres connection. The connection should not be in a transaction already.</p></li><li><p><code>name</code> (string): Optional name that this JobQueueWorker will filter the jobs on. If not necessary, argument can be skipped.</p></li><li><p><code>options</code>:</p><ul><li><p><code>pollInterval</code> (number): Interval in milliseconds that the worker should look for new jobs. Is only used if no job is found directly after completing a job. Defaults to 1500 milliseconds</p></li><li><p><code>parallelCount</code> (number): The number of parallel jobs to take on. This number should not be higher than the amount of connections your sql instance may create. Defaults to 1.</p></li><li><p><code>handlerTimeout</code> (number): The number of milliseconds the handler may run before it should be aborted. Note that only <code>newEventFromEvent</code> and <code>eventStart</code> check if an event is aborted by default. Defaults to 30 seconds.</p></li><li><p><code>handler</code> (function|object): The callback that is called on new jobs. If a job throws, the job is not marked as complete and retried most likely immediately. If an object is passed in it acts as a lookup table based on the job name. If no handler is found, the job will automatically pass. The object values may be just an handler or the following object:</p><div class="language-js"><pre><code><span class="token keyword">const</span> specifcHandlerSpecification <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> sql<span class="token punctuation">,</span> job</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  timout<span class="token operator">:</span> <span class="token number">1400</span><span class="token punctuation">,</span> <span class="token comment">// 1.4 seconds</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>The handler is called with the following parameters:</p><ul><li><code>event</code>: An @compas/stdlib event, which is aborted after the specified timeout. The event is already started and will be stopped by the job worker.</li><li><code>sql</code>: A Postgres connection already in transaction. If the transaction is aborted, the job is not marked complete.</li><li><code>job</code>: The job, containing <code>name</code>, <code>data</code>, <code>priority</code>, <code>scheduledAt</code>, <code>handlerTimeout</code>, <code>retryCount</code> and <code>createdAt</code> properties.</li></ul></li></ul></li></ul><p>Returns a new <code>JobQueueWorker</code> instance that is not started yet.</p><p><strong>start()</strong>:</p><p>Starts the worker if not already started. Returns synchronously.</p><p><strong>stop</strong>:</p><p>Stops the worker if not already stopped. Already running jobs will finish, but no new jobs will be picked up. Returns synchronously.</p><p><strong>pendingQueueSize()</strong>:</p><p>Get the amount of pending jobs left. If <code>name</code> is passed in the constructor, only pending jobs with the specified name will be returned.</p><p>Returns a promise that fulfills with an object.</p><ul><li><code>pendingCount</code>: The amount of jobs to be done in the future</li><li><code>scheduledCount</code>: The amount of jobs that is waiting on an available worker now.</li></ul><p><strong>averageTimeToCompletion()</strong>:</p><p>Get the average time to job completion between the specified start and end dates. If <code>name</code> is passed in the constructor, only jobs with the specified name will calculated.</p><p>Parameters:</p><ul><li><code>startDate</code> (Date): Date to filter jobs that completed after the specified timestamp.</li><li><code>endDate</code> (Date): Date to filter jobs that completed before the specified timestamp.</li></ul><p>Returns a promise that fulfills with a number.</p><p><strong>Example</strong></p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> JobQueueWorker <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@compas/store&quot;</span><span class="token punctuation">;</span>

<span class="token function">mainFn</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">,</span> main<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token parameter">logger</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">sql<span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;myImportantJob&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">&quot;Unhandled job&quot;</span><span class="token punctuation">,</span>
        name<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobQueueWorker</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    handler<span class="token punctuation">,</span>
    parallelCount<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  worker<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> startDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> endDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Set startDate 3 days in the past</span>
  startDate<span class="token punctuation">.</span><span class="token function">setUTCDate</span><span class="token punctuation">(</span>startDate<span class="token punctuation">.</span><span class="token function">getUTCDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    pendingQueueSize<span class="token operator">:</span> <span class="token keyword">await</span> worker<span class="token punctuation">.</span><span class="token function">pendingQueueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    averageTimeToCompletion<span class="token operator">:</span> <span class="token keyword">await</span> worker<span class="token punctuation">.</span><span class="token function">averageTimeToCompletion</span><span class="token punctuation">(</span>
      startDate<span class="token punctuation">,</span>
      endDate<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  worker<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>__VP_STATIC_END__`,36),p=[o];function c(i,l,r,u,d,k){return s(),a("div",null,p)}var m=n(t,[["render",c]]);export{b as __pageData,m as default};
