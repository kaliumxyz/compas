import{_ as n,c as s,o as a,a as t}from"./app.d0d65fcc.js";const h='{"title":"Code generator HTTP api","description":"","frontmatter":{},"headers":[{"level":2,"title":"Getting started","slug":"getting-started"},{"level":2,"title":"Query and path parameters","slug":"query-and-path-parameters"}],"relativePath":"features/code-gen-api.md","lastUpdated":1635769453832}',p={},o=t(`<h1 id="code-generator-http-api" tabindex="-1">Code generator HTTP api <a class="header-anchor" href="#code-generator-http-api" aria-hidden="true">#</a></h1><p>The next code generators all resolve around creating and consuming structured HTTP api&#39;s. If you are only interested in consuming Compas backed api&#39;s in frontend projects, see <a href="/features/code-gen-api-client.html">code gen api client</a>.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>Requires <code>@compas/cli</code>, <code>@compas/stdlib</code>, <code>@compas/server</code> and <code>@compas/code-gen</code> to be installed.</p></div><h2 id="getting-started" tabindex="-1">Getting started <a class="header-anchor" href="#getting-started" aria-hidden="true">#</a></h2><p>In the <a href="/features/code-gen-validators.html">validator &amp; type generator</a> we have seen how to utilize the Compas type system to generate types and validators. Here we are going to get some good use out of them. We are going to create API route definitions complete with integrated validators.</p><p>The <code>TypeCreator (T)</code> also contains the entry point for the route system, with <code>T.router(path)</code>. Let&#39;s define our first route:</p><div class="language-js"><pre><code><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">T</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeCreator</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">R</span> <span class="token operator">=</span> <span class="token constant">T</span><span class="token punctuation">.</span><span class="token function">router</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">R</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span><span class="token constant">T</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>And add <code>&quot;router&quot;</code> to the <code>enabledGenerators</code> in our <code>app.generate()</code> call like so:</p><div class="language-js"><pre><code><span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  outputDirectory<span class="token operator">:</span> <span class="token string">&quot;./src/generated&quot;</span><span class="token punctuation">,</span>
  isNodeServer<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  enabledGenerators<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;validator&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;router&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  dumpStructure<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>And execute the &#39;magic&#39;, <code>yarn compas generate</code>. This created a bunch of new files, so let&#39;s explain a few of them:</p><ul><li><code>src/generated/common/router.js</code>: this contains the full JavaScript route matcher, and the router entrypoint <code>router(ctx, next)</code> so you can add it to your Koa app.</li><li><code>src/generated/app/controller</code>: the file that contains the called controller functions, like our <code>hello</code> route.</li></ul><p>Since all generated files will be overwritten, we need to implement the controller in a new file. Create the follwing in <code>src/app/controller.js</code>:</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> appHandlers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../generated/app/controller.js&quot;</span><span class="token punctuation">;</span>

appHandlers<span class="token punctuation">.</span><span class="token function-variable function">hello</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;Hello world!&quot;</span><span class="token punctuation">;</span>

  <span class="token comment">// These are Koa middleware, so we allow other middleware&#39;s to run next.</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>And finally we need to mount the generated router on our Koa instance in <code>scripts/api.js</code>:</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> mainFn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@compas/stdlib&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@compas/server&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> router <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../src/generated/common/router.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Since we don&#39;t import our controllers any where, we need import them here to load our implementation.</span>
  <span class="token comment">// Else we would get &#39;405 Not implemented&#39; which is the default generated implementation.</span>
  <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;../src/app/controller.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>See <a href="/features/http-server.html">Http server</a> for more details on <code>getApp</code>.</p></div><p>Let&#39;s run the server and execute a request:</p><div class="language-shell"><pre><code><span class="token function">yarn</span> compas api
<span class="token function">curl</span> http://localhost:3000/hello
</code></pre></div><h2 id="query-and-path-parameters" tabindex="-1">Query and path parameters <a class="header-anchor" href="#query-and-path-parameters" aria-hidden="true">#</a></h2><p>Routes also support query and path parameters. Let&#39;s upgrade our <code>appHello</code> route (group &#39;app&#39;, route &#39;hello&#39;) to accept a thing to say greet, and if the greeting should be in uppercase.</p><div class="language-js"><pre><code>app<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
  <span class="token constant">R</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/hello/:thing&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;helloToThing&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">params</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      things<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// Note the convert. Query parameters are always strings,</span>
      <span class="token comment">// so to get and validate other primitives we need to enable conversion in the validators.</span>
      upperCase<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">.</span><span class="token function">bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span><span class="token constant">T</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Let&#39;s regenerate first, so we get our validators and typings and then add the controller implementation for <code>appHelloToThing</code> in <code>src/app/controller.js</code>:</p><div class="language-js"><pre><code>appHandlers<span class="token punctuation">.</span><span class="token function-variable function">helloToThing</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> greeting <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>ctx<span class="token punctuation">.</span>validatedParams<span class="token punctuation">.</span>thing<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>validatedQuery<span class="token punctuation">.</span>upperCase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    greeting <span class="token operator">=</span> greeting<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> greeting<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>The last thing we need to do is add a parser so the query string is parsed and thus can be validated. Change <code>srcipts/api.js</code> to:</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> mainFn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@compas/stdlib&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getApp<span class="token punctuation">,</span> createBodyParsers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@compas/server&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> setBodyParsers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../src/generated/common/router.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setBodyParsers</span><span class="token punctuation">(</span><span class="token function">createBodyParsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Since we don&#39;t import our controllers any where, we need import them here to load our implementation.</span>
  <span class="token comment">// Else we would get &#39;405 Not implemented&#39; which is the default generated implementation.</span>
  <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;../src/app/controller.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Lets startup the api again and execute some requests:</p><div class="language-shell"><pre><code><span class="token function">yarn</span> compas api
</code></pre></div><ul><li><code>curl http://localhost:3000/hello/world</code>: As expected, results in a <code>Hello world!</code></li><li><code>curl http://localhost:3000/hello/world?upperCase=true</code>: Results in <code>HELLO WORLD!</code>. Quite the greeting.</li><li><code>curl http://localhost:3000/hello/world?upperCase=5</code>: Oops a validator error. The query parameters are automatically validated based on the provided structure.</li><li><code>curl http://localhost:3000/hello/world/foo</code>: Path params match till the next <code>/</code> or the end of route. So appending <code>/foo</code> results in a 404.</li><li><code>curl http://localhost:3000/hello/world/</code>: However trailing slashes are allowed and ignored.</li></ul>`,28),e=[o];function c(u,l,i,r,k,d){return a(),s("div",null,e)}var m=n(p,[["render",c]]);export{h as __pageData,m as default};
